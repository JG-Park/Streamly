{% extends 'base/layout.html' %}

{% block title %}다운로드 - Streamly{% endblock %}

{% block content %}
<!-- 페이지 헤더 -->
<div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold">다운로드</h1>
    <div class="flex gap-2">
        <!-- 필터 -->
        <select id="statusFilter" class="select select-bordered">
            <option value="">모든 상태</option>
            <option value="pending">대기 중</option>
            <option value="downloading">다운로드 중</option>
            <option value="completed">완료됨</option>
            <option value="failed">실패</option>
        </select>
    </div>
</div>

<!-- 다운로드 통계 -->
<div class="stats shadow w-full mb-6">
    <div class="stat">
        <div class="stat-title">전체 다운로드</div>
        <div class="stat-value">{{ stats.total }}</div>
    </div>
    <div class="stat">
        <div class="stat-title">완료됨</div>
        <div class="stat-value text-success">{{ stats.completed }}</div>
    </div>
    <div class="stat">
        <div class="stat-title">대기 중</div>
        <div class="stat-value text-warning">{{ stats.pending }}</div>
    </div>
    <div class="stat">
        <div class="stat-title">실패</div>
        <div class="stat-value text-error">{{ stats.failed }}</div>
    </div>
    <div class="stat">
        <div class="stat-title">저장 공간</div>
        <div class="stat-value text-info">{{ stats.total_size }}</div>
    </div>
</div>

<!-- 다운로드 목록 (한 영상당 한 줄) -->
<div class="card bg-base-100 shadow-xl">
    <div class="card-body">
        <div class="overflow-x-auto">
            <table class="table table-zebra">
                <thead>
                    <tr>
                        <th>채널</th>
                        <th>제목</th>
                        <th>고화질</th>
                        <th>저화질</th>
                        <th>스트림 시간</th>
                    </tr>
                </thead>
                <tbody id="downloadTableBody">
                    {% for item in stream_downloads %}
                    <tr data-stream-id="{{ item.stream.id }}">
                        <td>
                            <div>
                                <div class="font-bold">{{ item.channel.name }}</div>
                                <div class="text-xs opacity-50">{{ item.channel.channel_id }}</div>
                            </div>
                        </td>
                        <td>
                            <div class="max-w-md">
                                <p class="truncate font-medium">{{ item.stream.title }}</p>
                                <p class="text-xs opacity-50">{{ item.stream.video_id }}</p>
                            </div>
                        </td>
                        <!-- 고화질 컬럼 -->
                        <td>
                            {% if item.high_quality %}
                            <div class="flex items-center gap-2">
                                <!-- 상태 뱃지 -->
                                <span class="badge badge-{% if item.high_quality.download.status == 'completed' %}success{% elif item.high_quality.download.status == 'downloading' %}info{% elif item.high_quality.download.status == 'pending' %}warning{% else %}error{% endif %} badge-sm">
                                    {% if item.high_quality.download.status == 'downloading' %}
                                        <span class="loading loading-spinner loading-xs mr-1"></span>
                                    {% endif %}
                                    {{ item.high_quality.status_display }}
                                </span>
                                
                                <!-- 포맷 및 용량 -->
                                <div class="text-xs">
                                    <span class="font-semibold">{{ item.high_quality.resolution }}</span>
                                    <span class="opacity-50">• {{ item.high_quality.file_size_display }}</span>
                                </div>
                                
                                <!-- 다운로드 진행률 (다운로드 중일 때만) -->
                                {% if item.high_quality.download.progress and item.high_quality.download.status == 'downloading' %}
                                <div class="flex items-center gap-1">
                                    <progress class="progress progress-primary w-12 h-1" value="{{ item.high_quality.download.progress }}" max="100"></progress>
                                    <span class="text-xs">{{ item.high_quality.download.progress }}%</span>
                                </div>
                                {% endif %}
                                
                                <!-- 액션 버튼 -->
                                <div class="flex gap-1 ml-auto">
                                    {% if item.high_quality.download.status == 'completed' %}
                                    <button onclick="playVideo({{ item.high_quality.download.id }})" class="btn btn-ghost btn-xs border-0 px-1" title="재생">
                                        <i class="fas fa-play"></i>
                                    </button>
                                    <button onclick="deleteDownload({{ item.high_quality.download.id }})" class="btn btn-ghost btn-xs border-0 px-1 text-error" title="삭제">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    {% elif item.high_quality.download.status == 'failed' %}
                                    <button onclick="retryDownload({{ item.high_quality.download.id }})" class="btn btn-ghost btn-xs border-0 px-1 text-warning" title="재시도">
                                        <i class="fas fa-redo"></i>
                                    </button>
                                    {% if item.high_quality.download.error_message %}
                                    <button onclick="showError({{ item.high_quality.download.id }})" class="btn btn-ghost btn-xs border-0 px-1 text-error" title="오류 보기">
                                        <i class="fas fa-info-circle"></i>
                                    </button>
                                    {% endif %}
                                    {% elif item.high_quality.download.status == 'downloading' %}
                                    <button onclick="cancelDownload({{ item.high_quality.download.id }})" class="btn btn-ghost btn-xs border-0 px-1 text-error" title="취소">
                                        <i class="fas fa-stop"></i>
                                    </button>
                                    {% elif item.high_quality.download.status == 'pending' %}
                                    <button onclick="forceDownload({{ item.high_quality.download.id }})" class="btn btn-ghost btn-xs border-0 px-1 text-primary" title="시작">
                                        <i class="fas fa-play-circle"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                            {% else %}
                            <span class="text-xs opacity-50">-</span>
                            {% endif %}
                        </td>
                        <!-- 저화질 컬럼 -->
                        <td>
                            {% if item.low_quality %}
                            <div class="flex items-center gap-2">
                                <!-- 상태 뱃지 -->
                                <span class="badge badge-{% if item.low_quality.download.status == 'completed' %}success{% elif item.low_quality.download.status == 'downloading' %}info{% elif item.low_quality.download.status == 'pending' %}warning{% else %}error{% endif %} badge-sm">
                                    {% if item.low_quality.download.status == 'downloading' %}
                                        <span class="loading loading-spinner loading-xs mr-1"></span>
                                    {% endif %}
                                    {{ item.low_quality.status_display }}
                                </span>
                                
                                <!-- 포맷 및 용량 -->
                                <div class="text-xs">
                                    <span class="font-semibold">{{ item.low_quality.resolution }}</span>
                                    <span class="opacity-50">• {{ item.low_quality.file_size_display }}</span>
                                </div>
                                
                                <!-- 다운로드 진행률 (다운로드 중일 때만) -->
                                {% if item.low_quality.download.progress and item.low_quality.download.status == 'downloading' %}
                                <div class="flex items-center gap-1">
                                    <progress class="progress progress-secondary w-12 h-1" value="{{ item.low_quality.download.progress }}" max="100"></progress>
                                    <span class="text-xs">{{ item.low_quality.download.progress }}%</span>
                                </div>
                                {% endif %}
                                
                                <!-- 액션 버튼 -->
                                <div class="flex gap-1 ml-auto">
                                    {% if item.low_quality.download.status == 'completed' %}
                                    <button onclick="playVideo({{ item.low_quality.download.id }})" class="btn btn-ghost btn-xs border-0 px-1" title="재생">
                                        <i class="fas fa-play"></i>
                                    </button>
                                    <button onclick="deleteDownload({{ item.low_quality.download.id }})" class="btn btn-ghost btn-xs border-0 px-1 text-error" title="삭제">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    {% elif item.low_quality.download.status == 'failed' %}
                                    <button onclick="retryDownload({{ item.low_quality.download.id }})" class="btn btn-ghost btn-xs border-0 px-1 text-warning" title="재시도">
                                        <i class="fas fa-redo"></i>
                                    </button>
                                    {% if item.low_quality.download.error_message %}
                                    <button onclick="showError({{ item.low_quality.download.id }})" class="btn btn-ghost btn-xs border-0 px-1 text-error" title="오류 보기">
                                        <i class="fas fa-info-circle"></i>
                                    </button>
                                    {% endif %}
                                    {% elif item.low_quality.download.status == 'downloading' %}
                                    <button onclick="cancelDownload({{ item.low_quality.download.id }})" class="btn btn-ghost btn-xs border-0 px-1 text-error" title="취소">
                                        <i class="fas fa-stop"></i>
                                    </button>
                                    {% elif item.low_quality.download.status == 'pending' %}
                                    <button onclick="forceDownload({{ item.low_quality.download.id }})" class="btn btn-ghost btn-xs border-0 px-1 text-primary" title="시작">
                                        <i class="fas fa-play-circle"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                            {% else %}
                            <span class="text-xs opacity-50">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if item.stream.started_at %}
                            <div>
                                <p class="text-sm">{{ item.stream.started_at|date:"Y-m-d" }}</p>
                                <p class="text-xs opacity-50">{{ item.stream.started_at|date:"H:i" }}</p>
                            </div>
                            {% else %}
                            <span class="text-xs opacity-50">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center opacity-50">다운로드가 없습니다</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- 페이지네이션 -->
        {% if page_obj %}
        <div class="join mt-4">
            {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}" class="join-item btn">«</a>
            {% endif %}
            
            {% for num in page_obj.paginator.page_range %}
                {% if num == page_obj.number %}
                <button class="join-item btn btn-active">{{ num }}</button>
                {% else %}
                <a href="?page={{ num }}" class="join-item btn">{{ num }}</a>
                {% endif %}
            {% endfor %}
            
            {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}" class="join-item btn">»</a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<!-- 에러 메시지 모달 -->
<dialog id="errorModal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg mb-4">다운로드 오류</h3>
        <pre id="errorMessage" class="bg-base-200 p-4 rounded overflow-x-auto text-xs"></pre>
        <div class="modal-action">
            <button onclick="document.getElementById('errorModal').close()" class="btn">닫기</button>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<!-- 삭제 확인 모달 -->
<dialog id="deleteModal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg mb-4">다운로드 삭제</h3>
        <p>이 다운로드를 삭제하시겠습니까? 파일도 함께 삭제됩니다.</p>
        <div class="modal-action">
            <button onclick="closeDeleteModal()" class="btn">취소</button>
            <button onclick="confirmDelete()" class="btn btn-error">삭제</button>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<script>
// 에러 메시지를 전역 변수로 저장
window.errorMessages = {};
{% for item in stream_downloads %}
    {% if item.high_quality and item.high_quality.download.error_message %}
    window.errorMessages[{{ item.high_quality.download.id }}] = "{{ item.high_quality.download.error_message|escapejs }}";
    {% endif %}
    {% if item.low_quality and item.low_quality.download.error_message %}
    window.errorMessages[{{ item.low_quality.download.id }}] = "{{ item.low_quality.download.error_message|escapejs }}";
    {% endif %}
{% endfor %}

// 필터링 (간단하게)
document.getElementById('statusFilter').addEventListener('change', function() {
    const filter = this.value;
    const rows = document.querySelectorAll('#downloadTableBody tr');
    
    rows.forEach(row => {
        if (!filter) {
            row.style.display = '';
            return;
        }
        
        // 해당 행의 모든 상태 배지 확인
        const badges = row.querySelectorAll('.badge');
        let hasStatus = false;
        
        badges.forEach(badge => {
            const text = badge.textContent.trim().toLowerCase();
            if (filter === 'pending' && text.includes('대기')) hasStatus = true;
            if (filter === 'downloading' && text.includes('다운로드')) hasStatus = true;
            if (filter === 'completed' && text.includes('완료')) hasStatus = true;
            if (filter === 'failed' && text.includes('실패')) hasStatus = true;
        });
        
        row.style.display = hasStatus ? '' : 'none';
    });
});

// 모든 다운로드 관련 함수들은 app.js에 정의되어 있음

// 5초마다 새로고침 (다운로드 중인 항목이 있을 때)
{% if downloading_count > 0 %}
setTimeout(() => location.reload(), 5000);
{% endif %}
</script>
{% endblock %}