{% extends 'base/layout.html' %}

{% block title %}다운로드 - Streamly{% endblock %}

{% block content %}
<!-- 페이지 헤더 -->
<div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold">다운로드</h1>
    <div class="flex gap-2">
        <!-- 필터 -->
        <select id="statusFilter" class="select select-bordered">
            <option value="">모든 상태</option>
            <option value="pending">대기 중</option>
            <option value="downloading">다운로드 중</option>
            <option value="completed">완료됨</option>
            <option value="failed">실패</option>
        </select>
        <select id="qualityFilter" class="select select-bordered">
            <option value="">모든 품질</option>
            <option value="best">고화질</option>
            <option value="worst">저화질</option>
        </select>
    </div>
</div>

<!-- 다운로드 통계 -->
<div class="stats shadow w-full mb-6">
    <div class="stat">
        <div class="stat-title">전체 다운로드</div>
        <div class="stat-value">{{ stats.total }}</div>
    </div>
    <div class="stat">
        <div class="stat-title">완료됨</div>
        <div class="stat-value text-success">{{ stats.completed }}</div>
    </div>
    <div class="stat">
        <div class="stat-title">대기 중</div>
        <div class="stat-value text-warning">{{ stats.pending }}</div>
    </div>
    <div class="stat">
        <div class="stat-title">실패</div>
        <div class="stat-value text-error">{{ stats.failed }}</div>
    </div>
    <div class="stat">
        <div class="stat-title">저장 공간</div>
        <div class="stat-value text-info">{{ stats.total_size }}</div>
    </div>
</div>

<!-- 품질별 그룹화된 다운로드 목록 -->
<div class="space-y-6">
    <!-- 고화질 다운로드 -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <h2 class="card-title text-xl mb-4">
                <i class="fas fa-video text-primary"></i>
                고화질 다운로드
            </h2>
            <div class="overflow-x-auto">
                <table class="table table-zebra">
                    <thead>
                        <tr>
                            <th>상태</th>
                            <th>채널</th>
                            <th>제목</th>
                            <th>해상도 / 코덱</th>
                            <th>크기</th>
                            <th>다운로드 시간</th>
                            <th>액션</th>
                        </tr>
                    </thead>
                    <tbody id="highQualityTableBody">
                        {% for item in downloads %}
                        {% if item.download.quality == 'best' or item.download.quality == 'high' %}
                        <tr data-status="{{ item.download.status }}" data-quality="{{ item.download.quality }}">
                            <td>
                            <span class="badge badge-{% if item.download.status == 'completed' %}success{% elif item.download.status == 'downloading' %}info{% elif item.download.status == 'pending' %}warning{% else %}error{% endif %}">
                                {% if item.download.status == 'downloading' %}
                                    <span class="loading loading-spinner loading-xs mr-1"></span>
                                {% endif %}
                                {{ item.download.get_status_display }}
                            </span>
                            {% if item.download.progress %}
                            <div class="mt-1">
                                <progress class="progress progress-primary w-20" value="{{ item.download.progress }}" max="100"></progress>
                                <span class="text-xs">{{ item.download.progress }}%</span>
                            </div>
                            {% endif %}
                        </td>
                        <td>
                            <div>
                                <div class="font-bold">{{ item.download.live_stream.channel.name }}</div>
                                <div class="text-xs opacity-50">{{ item.download.live_stream.channel.channel_id }}</div>
                            </div>
                        </td>
                        <td>
                            <div class="max-w-md">
                                <p class="truncate font-medium">{{ item.download.live_stream.title }}</p>
                                <p class="text-xs opacity-50">{{ item.download.live_stream.video_id }}</p>
                            </div>
                        </td>
                        <td>
                            <div>
                                {% if item.download.resolution %}
                                    <p class="font-bold">{{ item.download.resolution }}</p>
                                {% else %}
                                    <p class="font-bold">미확인</p>
                                {% endif %}
                                {% if item.download.video_codec or item.download.audio_codec %}
                                    <p class="text-xs opacity-50">
                                        {% if item.download.video_codec %}V: {{ item.download.video_codec }}{% endif %}
                                        {% if item.download.audio_codec %}A: {{ item.download.audio_codec }}{% endif %}
                                    </p>
                                {% endif %}
                            </div>
                        </td>
                        <td>
                            {{ item.file_size_display }}
                        </td>
                        <td>
                            {% if item.download.completed_at %}
                                <div>
                                    <p>{{ item.download.completed_at|date:"Y-m-d" }}</p>
                                    <p class="text-xs opacity-50">{{ item.download.completed_at|date:"H:i:s" }}</p>
                                </div>
                            {% else %}
                                <p class="text-xs opacity-50">{{ item.download.created_at|timesince }} 전</p>
                            {% endif %}
                        </td>
                        <td>
                            <div class="flex gap-1">
                                {% if item.download.status == 'completed' %}
                                <button onclick="playVideo({{ item.download.id }})" class="btn btn-xs btn-ghost">
                                    <i class="fas fa-play"></i>
                                </button>
                                <button onclick="deleteDownload({{ item.download.id }})" class="btn btn-xs btn-error">
                                    <i class="fas fa-trash"></i>
                                </button>
                                {% elif item.download.status == 'failed' %}
                                <button onclick="retryDownload({{ item.download.id }})" class="btn btn-xs btn-warning">
                                    <i class="fas fa-redo"></i>
                                </button>
                                <button onclick="forceDownload({{ item.download.id }})" class="btn btn-xs btn-info" title="강제 다운로드">
                                    <i class="fas fa-bolt"></i>
                                </button>
                                {% if item.download.error_message %}
                                <button onclick="showError({{ item.download.id }})" class="btn btn-xs btn-ghost">
                                    <i class="fas fa-info-circle"></i>
                                </button>
                                {% endif %}
                                {% elif item.download.status == 'downloading' %}
                                <button onclick="cancelDownload({{ item.download.id }})" class="btn btn-xs btn-error">
                                    <i class="fas fa-stop"></i>
                                </button>
                                {% elif item.download.status == 'pending' %}
                                <button onclick="forceDownload({{ item.download.id }})" class="btn btn-xs btn-primary" title="강제 다운로드">
                                    <i class="fas fa-play-circle"></i> 시작
                                </button>
                                {% endif %}
                            </div>
                        </td>
                        </tr>
                        {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
                {% if not has_high_quality %}
                <div class="text-center py-4 opacity-50">
                    고화질 다운로드가 없습니다
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- 저화질 다운로드 -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <h2 class="card-title text-xl mb-4">
                <i class="fas fa-compress text-secondary"></i>
                저화질 다운로드
            </h2>
            <div class="overflow-x-auto">
                <table class="table table-zebra">
                    <thead>
                        <tr>
                            <th>상태</th>
                            <th>채널</th>
                            <th>제목</th>
                            <th>해상도 / 코덱</th>
                            <th>크기</th>
                            <th>다운로드 시간</th>
                            <th>액션</th>
                        </tr>
                    </thead>
                    <tbody id="lowQualityTableBody">
                        {% for item in downloads %}
                        {% if item.download.quality == 'worst' or item.download.quality == 'low' %}
                        <tr data-status="{{ item.download.status }}" data-quality="{{ item.download.quality }}">
                            <td>
                                <span class="badge badge-{% if item.download.status == 'completed' %}success{% elif item.download.status == 'downloading' %}info{% elif item.download.status == 'pending' %}warning{% else %}error{% endif %}">
                                    {% if item.download.status == 'downloading' %}
                                        <span class="loading loading-spinner loading-xs mr-1"></span>
                                    {% endif %}
                                    {{ item.download.get_status_display }}
                                </span>
                                {% if item.download.progress %}
                                <div class="mt-1">
                                    <progress class="progress progress-primary w-20" value="{{ item.download.progress }}" max="100"></progress>
                                    <span class="text-xs">{{ item.download.progress }}%</span>
                                </div>
                                {% endif %}
                            </td>
                            <td>
                                <div>
                                    <div class="font-bold">{{ item.download.live_stream.channel.name }}</div>
                                    <div class="text-xs opacity-50">{{ item.download.live_stream.channel.channel_id }}</div>
                                </div>
                            </td>
                            <td>
                                <div class="max-w-md">
                                    <p class="truncate font-medium">{{ item.download.live_stream.title }}</p>
                                    <p class="text-xs opacity-50">{{ item.download.live_stream.video_id }}</p>
                                </div>
                            </td>
                            <td>
                                <div>
                                    {% if item.download.resolution %}
                                        <p class="font-bold">{{ item.download.resolution }}</p>
                                    {% else %}
                                        <p class="font-bold">미확인</p>
                                    {% endif %}
                                    {% if item.download.video_codec or item.download.audio_codec %}
                                        <p class="text-xs opacity-50">
                                            {% if item.download.video_codec %}V: {{ item.download.video_codec }}{% endif %}
                                            {% if item.download.audio_codec %}A: {{ item.download.audio_codec }}{% endif %}
                                        </p>
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                {{ item.file_size_display }}
                            </td>
                            <td>
                                {% if item.download.completed_at %}
                                    <div>
                                        <p>{{ item.download.completed_at|date:"Y-m-d" }}</p>
                                        <p class="text-xs opacity-50">{{ item.download.completed_at|date:"H:i:s" }}</p>
                                    </div>
                                {% else %}
                                    <p class="text-xs opacity-50">{{ item.download.created_at|timesince }} 전</p>
                                {% endif %}
                            </td>
                            <td>
                                <div class="flex gap-1">
                                    {% if item.download.status == 'completed' %}
                                    <button onclick="playVideo({{ item.download.id }})" class="btn btn-xs btn-ghost">
                                        <i class="fas fa-play"></i>
                                    </button>
                                    <button onclick="deleteDownload({{ item.download.id }})" class="btn btn-xs btn-error">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    {% elif item.download.status == 'failed' %}
                                    <button onclick="retryDownload({{ item.download.id }})" class="btn btn-xs btn-warning">
                                        <i class="fas fa-redo"></i>
                                    </button>
                                    <button onclick="forceDownload({{ item.download.id }})" class="btn btn-xs btn-info" title="강제 다운로드">
                                        <i class="fas fa-bolt"></i>
                                    </button>
                                    {% if item.download.error_message %}
                                    <button onclick="showError({{ item.download.id }})" class="btn btn-xs btn-ghost">
                                        <i class="fas fa-info-circle"></i>
                                    </button>
                                    {% endif %}
                                    {% elif item.download.status == 'downloading' %}
                                    <button onclick="cancelDownload({{ item.download.id }})" class="btn btn-xs btn-error">
                                        <i class="fas fa-stop"></i>
                                    </button>
                                    {% elif item.download.status == 'pending' %}
                                    <button onclick="forceDownload({{ item.download.id }})" class="btn btn-xs btn-primary" title="강제 다운로드">
                                        <i class="fas fa-play-circle"></i> 시작
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
                {% if not has_low_quality %}
                <div class="text-center py-4 opacity-50">
                    저화질 다운로드가 없습니다
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
        
        <!-- 페이지네이션 -->
        {% if page_obj %}
        <div class="join mt-4">
            {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}" class="join-item btn">«</a>
            {% endif %}
            
            {% for num in page_obj.paginator.page_range %}
                {% if num == page_obj.number %}
                <button class="join-item btn btn-active">{{ num }}</button>
                {% else %}
                <a href="?page={{ num }}" class="join-item btn">{{ num }}</a>
                {% endif %}
            {% endfor %}
            
            {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}" class="join-item btn">»</a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<!-- 에러 메시지 모달 -->
<dialog id="errorModal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg mb-4">다운로드 오류</h3>
        <pre id="errorMessage" class="bg-base-200 p-4 rounded overflow-x-auto text-xs"></pre>
        <div class="modal-action">
            <button onclick="document.getElementById('errorModal').close()" class="btn">닫기</button>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<!-- 삭제 확인 모달 -->
<dialog id="deleteModal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg mb-4">다운로드 삭제</h3>
        <p>이 다운로드를 삭제하시겠습니까? 파일도 함께 삭제됩니다.</p>
        <div class="modal-action">
            <button onclick="closeDeleteModal()" class="btn">취소</button>
            <button onclick="confirmDelete()" class="btn btn-error">삭제</button>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<script>
// 에러 메시지를 전역 변수로 저장
window.errorMessages = {};
{% for download in downloads %}
    {% if download.error_message %}
    window.errorMessages[{{ download.id }}] = "{{ download.error_message|escapejs }}";
    {% endif %}
{% endfor %}

// 필터링
document.getElementById('statusFilter').addEventListener('change', filterDownloads);
document.getElementById('qualityFilter').addEventListener('change', filterDownloads);

function filterDownloads() {
    const statusFilter = document.getElementById('statusFilter').value;
    const qualityFilter = document.getElementById('qualityFilter').value;
    
    // 고화질 테이블 필터링
    const highRows = document.querySelectorAll('#highQualityTableBody tr');
    highRows.forEach(row => {
        const status = row.dataset.status;
        const quality = row.dataset.quality;
        
        let show = true;
        if (statusFilter && status !== statusFilter) show = false;
        if (qualityFilter && qualityFilter !== 'best' && qualityFilter !== quality) show = false;
        
        row.style.display = show ? '' : 'none';
    });
    
    // 저화질 테이블 필터링
    const lowRows = document.querySelectorAll('#lowQualityTableBody tr');
    lowRows.forEach(row => {
        const status = row.dataset.status;
        const quality = row.dataset.quality;
        
        let show = true;
        if (statusFilter && status !== statusFilter) show = false;
        if (qualityFilter && qualityFilter !== 'worst' && qualityFilter !== quality) show = false;
        
        row.style.display = show ? '' : 'none';
    });
}

// 모든 다운로드 관련 함수들은 app.js에 정의되어 있음

// 5초마다 새로고침 (다운로드 중인 항목이 있을 때)
{% if downloading_count > 0 %}
setTimeout(() => location.reload(), 5000);
{% endif %}
</script>
{% endblock %}