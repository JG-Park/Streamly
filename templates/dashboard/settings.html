{% extends 'base/layout.html' %}

{% block title %}설정 - Streamly{% endblock %}

{% block content %}
<!-- 페이지 헤더 -->
<div class="mb-6">
    <h1 class="text-3xl font-bold">설정</h1>
    <p class="text-base-content/70 mt-2">시스템 설정 및 환경 구성</p>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- 일반 설정 -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <h2 class="card-title">
                <i class="fas fa-cog"></i>
                일반 설정
            </h2>
            
            <div class="space-y-4">
                <!-- 보관 기간 -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">파일 보관 기간</span>
                        <span class="label-text-alt">다운로드된 파일 자동 삭제</span>
                    </label>
                    <div class="input-group">
                        <input type="number" id="retentionDays" value="{{ settings.retention_days }}" 
                               min="1" max="365" class="input input-bordered w-full">
                        <span class="btn">일</span>
                    </div>
                </div>
                
                <!-- 체크 주기 -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">기본 체크 주기</span>
                        <span class="label-text-alt">채널 확인 간격</span>
                    </label>
                    <div class="input-group">
                        <input type="number" id="checkInterval" value="{{ settings.check_interval }}" 
                               min="1" max="60" class="input input-bordered w-full">
                        <span class="btn">분</span>
                    </div>
                </div>
                
                <!-- 다운로드 품질 -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">기본 다운로드 품질</span>
                    </label>
                    <select id="defaultQuality" class="select select-bordered w-full">
                        <option value="both" {% if settings.default_quality == 'both' %}selected{% endif %}>둘 다</option>
                        <option value="best" {% if settings.default_quality == 'best' %}selected{% endif %}>고화질만</option>
                        <option value="worst" {% if settings.default_quality == 'worst' %}selected{% endif %}>저화질만</option>
                    </select>
                </div>
                
                <button onclick="saveGeneralSettings()" class="btn btn-primary w-full">
                    <i class="fas fa-save mr-2"></i>
                    일반 설정 저장
                </button>
            </div>
        </div>
    </div>
    
    <!-- 텔레그램 설정 -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <h2 class="card-title">
                <i class="fab fa-telegram"></i>
                텔레그램 알림
            </h2>
            
            <div class="space-y-4">
                <!-- 봇 토큰 -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">봇 토큰</span>
                        <span class="label-text-alt">BotFather에서 발급</span>
                    </label>
                    <input type="text" id="telegramToken" placeholder="123456789:ABCdefGHIjklMNOpqrsTUVwxyz" 
                           value="{{ settings.telegram_token_masked }}" class="input input-bordered w-full">
                </div>
                
                <!-- 채팅 ID -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">채팅 ID</span>
                        <span class="label-text-alt">알림 받을 채팅방 ID</span>
                    </label>
                    <input type="text" id="telegramChatId" placeholder="-1001234567890" 
                           value="{{ settings.telegram_chat_id }}" class="input input-bordered w-full">
                </div>
                
                <!-- 알림 설정 -->
                <div class="form-control">
                    <label class="label cursor-pointer">
                        <span class="label-text">라이브 시작 알림</span>
                        <input type="checkbox" id="notifyLiveStart" class="toggle toggle-primary" 
                               {% if settings.notify_live_start %}checked{% endif %}>
                    </label>
                </div>
                
                <div class="form-control">
                    <label class="label cursor-pointer">
                        <span class="label-text">다운로드 완료 알림</span>
                        <input type="checkbox" id="notifyDownloadComplete" class="toggle toggle-primary" 
                               {% if settings.notify_download_complete %}checked{% endif %}>
                    </label>
                </div>
                
                <div class="form-control">
                    <label class="label cursor-pointer">
                        <span class="label-text">오류 알림</span>
                        <input type="checkbox" id="notifyErrors" class="toggle toggle-primary" 
                               {% if settings.notify_errors %}checked{% endif %}>
                    </label>
                </div>
                
                <div class="flex gap-2">
                    <button onclick="testTelegram()" class="btn btn-secondary flex-1">
                        <i class="fas fa-paper-plane mr-2"></i>
                        테스트 메시지
                    </button>
                    <button onclick="saveTelegramSettings()" class="btn btn-primary flex-1">
                        <i class="fas fa-save mr-2"></i>
                        저장
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 저장 경로 설정 -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <h2 class="card-title">
                <i class="fas fa-folder"></i>
                저장 경로
            </h2>
            
            <div class="space-y-4">
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">다운로드 경로</span>
                    </label>
                    <input type="text" id="downloadPath" value="{{ settings.download_path }}" 
                           class="input input-bordered w-full" readonly>
                    <label class="label">
                        <span class="label-text-alt">Docker 환경에서는 변경 불가</span>
                    </label>
                </div>
                
                <!-- 디스크 사용량 -->
                <div class="stats shadow">
                    <div class="stat">
                        <div class="stat-title">사용 중</div>
                        <div class="stat-value text-primary">{{ disk_usage.used }}</div>
                        <div class="stat-desc">{{ disk_usage.percent }}% 사용</div>
                    </div>
                    <div class="stat">
                        <div class="stat-title">여유 공간</div>
                        <div class="stat-value text-success">{{ disk_usage.free }}</div>
                        <div class="stat-desc">전체: {{ disk_usage.total }}</div>
                    </div>
                </div>
                
                <button onclick="cleanupOldFiles()" class="btn btn-warning w-full">
                    <i class="fas fa-broom mr-2"></i>
                    오래된 파일 정리
                </button>
            </div>
        </div>
    </div>
    
    <!-- 시스템 정보 -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <h2 class="card-title">
                <i class="fas fa-info-circle"></i>
                시스템 정보
            </h2>
            
            <div class="space-y-2">
                <div class="flex justify-between">
                    <span class="opacity-70">버전</span>
                    <span class="font-mono">{{ version }}</span>
                </div>
                <div class="flex justify-between">
                    <span class="opacity-70">Python</span>
                    <span class="font-mono">{{ python_version }}</span>
                </div>
                <div class="flex justify-between">
                    <span class="opacity-70">Django</span>
                    <span class="font-mono">{{ django_version }}</span>
                </div>
                <div class="flex justify-between">
                    <span class="opacity-70">yt-dlp</span>
                    <span class="font-mono">{{ ytdlp_version }}</span>
                </div>
                <div class="flex justify-between">
                    <span class="opacity-70">Redis</span>
                    <span class="badge badge-success">연결됨</span>
                </div>
                <div class="flex justify-between">
                    <span class="opacity-70">Celery</span>
                    <span class="badge badge-success">활성</span>
                </div>
            </div>
            
            <div class="divider"></div>
            
            <div class="space-y-2">
                <button onclick="updateYtdlp()" class="btn btn-secondary w-full">
                    <i class="fas fa-sync mr-2"></i>
                    yt-dlp 업데이트
                </button>
                <a href="/dashboard/logs/" class="btn btn-ghost w-full">
                    <i class="fas fa-file-alt mr-2"></i>
                    시스템 로그 보기
                </a>
            </div>
        </div>
    </div>
</div>

<!-- 위험 구역 -->
<div class="card bg-base-100 shadow-xl mt-6 border-2 border-error">
    <div class="card-body">
        <h2 class="card-title text-error">
            <i class="fas fa-exclamation-triangle"></i>
            위험 구역
        </h2>
        <p class="opacity-70">이 작업들은 되돌릴 수 없습니다. 신중하게 진행하세요.</p>
        
        <div class="flex flex-wrap gap-2 mt-4">
            <button onclick="processPendingDownloads()" class="btn btn-success">
                <i class="fas fa-play-circle mr-2"></i>
                대기 중 다운로드 처리
            </button>
            <button onclick="fixDownloadStatus()" class="btn btn-info">
                <i class="fas fa-wrench mr-2"></i>
                다운로드 상태 수정
            </button>
            <button onclick="clearAllDownloads()" class="btn btn-error">
                <i class="fas fa-trash mr-2"></i>
                모든 다운로드 삭제
            </button>
            <button onclick="resetDatabase()" class="btn btn-error">
                <i class="fas fa-database mr-2"></i>
                데이터베이스 초기화
            </button>
            <button onclick="clearLogs()" class="btn btn-warning">
                <i class="fas fa-eraser mr-2"></i>
                로그 삭제
            </button>
        </div>
    </div>
</div>

<script>
// 일반 설정 저장
async function saveGeneralSettings() {
    const data = {
        retention_days: parseInt(document.getElementById('retentionDays').value),
        check_interval: parseInt(document.getElementById('checkInterval').value),
        default_quality: document.getElementById('defaultQuality').value
    };
    
    try {
        await app.apiRequest('POST', '/settings/general/', data);
        showToast('success', '일반 설정이 저장되었습니다.');
    } catch (error) {
        showToast('error', '설정 저장 실패');
    }
}

// 텔레그램 설정 저장
async function saveTelegramSettings() {
    const token = document.getElementById('telegramToken').value;
    const chatId = document.getElementById('telegramChatId').value;
    
    // 마스킹된 토큰인지 확인
    if (token && !token.includes('*')) {
        const data = {
            bot_token: token,
            chat_id: chatId,
            notify_live_start: document.getElementById('notifyLiveStart').checked,
            notify_download_complete: document.getElementById('notifyDownloadComplete').checked,
            notify_errors: document.getElementById('notifyErrors').checked
        };
        
        try {
            await app.apiRequest('POST', '/settings/telegram_config/', data);
            showToast('success', '텔레그램 설정이 저장되었습니다.');
        } catch (error) {
            showToast('error', '설정 저장 실패');
        }
    } else if (!token.includes('*')) {
        showToast('error', '올바른 봇 토큰을 입력해주세요.');
    }
}

// 텔레그램 테스트
async function testTelegram() {
    try {
        await app.apiRequest('POST', '/telegram/test/', {
            message: '테스트 메시지입니다. 텔레그램 연동이 정상적으로 작동합니다!'
        });
        showToast('success', '테스트 메시지가 전송되었습니다.');
    } catch (error) {
        showToast('error', '테스트 메시지 전송 실패. 설정을 확인해주세요.');
    }
}

// yt-dlp 업데이트
async function updateYtdlp() {
    if (!confirm('yt-dlp를 최신 버전으로 업데이트하시겠습니까?')) return;
    
    try {
        showToast('info', 'yt-dlp 업데이트 중...');
        await app.apiRequest('POST', '/settings/update_ytdlp/');
        showToast('success', 'yt-dlp가 업데이트되었습니다.');
    } catch (error) {
        showToast('error', '업데이트 실패');
    }
}

// 오래된 파일 정리
async function cleanupOldFiles() {
    if (!confirm('보관 기간이 지난 파일들을 삭제하시겠습니까?')) return;
    
    try {
        const result = await app.apiRequest('POST', '/settings/cleanup_files/');
        showToast('success', `${result.deleted_count}개의 파일이 삭제되었습니다.`);
    } catch (error) {
        showToast('error', '파일 정리 실패');
    }
}

// 위험 구역 함수들
async function clearAllDownloads() {
    if (!confirm('정말로 모든 다운로드를 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) return;
    if (!confirm('마지막 확인: 모든 다운로드된 파일이 영구적으로 삭제됩니다. 계속하시겠습니까?')) return;
    
    try {
        await app.apiRequest('POST', '/settings/clear_downloads/');
        showToast('success', '모든 다운로드가 삭제되었습니다.');
        setTimeout(() => location.reload(), 2000);
    } catch (error) {
        showToast('error', '삭제 실패');
    }
}

async function resetDatabase() {
    alert('보안을 위해 이 작업은 서버 콘솔에서만 가능합니다.');
}

async function clearLogs() {
    if (!confirm('모든 시스템 로그를 삭제하시겠습니까?')) return;
    
    try {
        await app.apiRequest('POST', '/settings/clear_logs/');
        showToast('success', '로그가 삭제되었습니다.');
    } catch (error) {
        showToast('error', '로그 삭제 실패');
    }
}

// 대기 중 다운로드 처리
async function processPendingDownloads() {
    if (!confirm('대기 중인 모든 다운로드를 시작하시겠습니까?')) return;
    
    try {
        showToast('info', '대기 중 다운로드 처리 중...');
        const result = await app.apiRequest('POST', '/settings/process_pending_downloads/');
        
        if (result.processed_count > 0) {
            showToast('success', `${result.processed_count}개의 다운로드가 시작되었습니다.`);
            
            // 시작된 다운로드 목록 표시
            if (result.started_downloads && result.started_downloads.length > 0) {
                console.log('시작된 다운로드:', result.started_downloads);
            }
        } else {
            showToast('info', '처리할 대기 중 다운로드가 없습니다.');
        }
    } catch (error) {
        showToast('error', '대기 중 다운로드 처리 실패');
    }
}

// 다운로드 상태 수정
async function fixDownloadStatus() {
    if (!confirm('멈춘 다운로드 상태를 수정하시겠습니까?')) return;
    
    try {
        showToast('info', '다운로드 상태 수정 중...');
        const result = await app.apiRequest('POST', '/settings/fix_download_status/');
        showToast('success', result.message);
        
        // 결과 상세 정보 표시
        if (result.output) {
            console.log('수정 결과:', result.output);
        }
    } catch (error) {
        showToast('error', '상태 수정 실패');
    }
}
</script>
{% endblock %}